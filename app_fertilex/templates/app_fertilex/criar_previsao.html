<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Criar Análise</title>
    <!-- Inclua os arquivos CSS e JS do Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
    <style>
        
    </style>
</head>
<body>
    <header class="bg-primary text-white text-center py-3">
        <h1>Analisar Fertilidade do Solo</h1>
    </header>
    <div class="container-fluid mt-5">
        <p class="m-5">Caso deixe um campo vazio, será considerado como '0'</p>
        <form method="post" action="{% url 'app_fertilex:prever_nova' %}">
            {% csrf_token %}
            <div class="m-5">
                <label for="num-rows" class="form-label">Número de Linhas:</label>
                <input type="number" id="num-rows" name="num_rows" class="form-control" min="0" value="0">
            </div>
            <div class="table-responsive m-5" style="max-height: 400px;">
                <table class="table table-fixed" id="formset-table">
                    <thead class="table-primary text-center">
                        <tr>
                            <th>ID</th>
                            <th>N</th>
                            <th>P</th>
                            <th>K</th>
                            <th>pH</th>
                            <th>EC</th>
                            <th>OC</th>
                            <th>S</th>
                            <th>Zn</th>
                            <th>Fe</th>
                            <th>Cu</th>
                            <th>Mn</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Linhas são adicionados aqui -->
                    </tbody>
                </table>
            </div>
            <div class="m-5">
                <button type="button" id="add-row" class="btn btn-success">Adicionar Linha</button>
                <button type="submit" class="btn btn-primary">Ver Resultado</button>
                <button type="button" id="limpar-form" class="btn btn-danger" name="limpar" >Limpar</button>
            </div>
        </form>
        <div class="m-5">
            {% for previsao in previsoes %}
                <h1>{{ previsao.id }}</h1>
                <h3>{{ previsao.titulo }}</h3>
                <p>Data de Criação: {{ previsao.data_criacao }}</p>
                <h4>Resultados:</h4>
                <ul id="resultados-list-{{ previsao.id }}">
                    {% for resultado in previsao.resultados %}
                        <li>{{ resultado }}</li>
                    {% endfor %}
                </ul>
            {% endfor %}
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function() {
            // Função para adicionar uma nova linha
            var numRows = 1;
            var nextID =0;
            function addRow() {
                nextID++;
                var newRow = '<tr>' +
                    '<td>' + nextID + '</td>' +
                    '<td><input type="number" name="N[]" step="any"></td>' +
                    '<td><input type="number" name="P[]" step="any"></td>' +
                    '<td><input type="number" name="K[]" step="any"></td>' +
                    '<td><input type="number" name="pH[]" step="any"></td>' +
                    '<td><input type="number" name="EC[]" step="any"></td>' +
                    '<td><input type="number" name="OC[]" step="any"></td>' +
                    '<td><input type="number" name="S[]" step="any"></td>' +
                    '<td><input type="number" name="Zn[]" step="any"></td>' +
                    '<td><input type="number" name="Fe[]" step="any"></td>' +
                    '<td><input type="number" name="Cu[]" step="any"></td>' +
                    '<td><input type="number" name="Mn[]" step="any"></td>' +
                    '</tr>';
                $('#formset-table tbody').append(newRow);
                // Atualize o valor do campo "Número de Linhas Extras"
                numRows = $('#formset-table tbody tr').length;
                $('#num-rows').val(numRows);
                // Salve os dados no armazenamento local
                saveFormData();
                // Role a tabela para a última linha adicionada
                $('#formset-table').scrollTop($('#formset-table')[0].scrollHeight);
            }

            // Função para salvar os dados do formulário no armazenamento local
            function saveFormData() {
                var formData = {
                    num_rows: $('#num-rows').val(),
                    rows: []
                };
                $('#formset-table tbody tr').each(function() {
                    var row = {};
                    $(this).find('input[type="number"]').each(function() {
                        row[$(this).attr('name')] = $(this).val();
                    });
                    formData.rows.push(row);
                });
                localStorage.setItem('formData', JSON.stringify(formData));
            }

            // Função para carregar os dados do formulário do armazenamento local
            function loadFormData() {
                var formData = JSON.parse(localStorage.getItem('formData'));
                if (formData) {
                    $('#num-rows').val(formData.num_rows);
                    for (var i = 0; i < formData.num_rows; i++) {
                        addRow();
                        var row = formData.rows[i];
                        $('#formset-table tbody tr:last-child input[type="number"]').each(function() {
                            var fieldName = $(this).attr('name');
                            $(this).val(row[fieldName]);
                        });
                    }
                }
            }
            
            
            function adicionarResultado(previsaoID, resultado) {
                var resultadosList = $('#resultados-list-' + previsaoID);
                var resultadoItem = $('<li></li>');
                resultadoItem.text('Resultado: ' + resultado);
                resultadosList.append(resultadoItem);
            }

            // Carregue os dados do formulário ao carregar a página
            loadFormData();

            // Manipulador para o botão "Adicionar Linha"
            $("#add-row").click(function() {
                addRow();
            });

            // Manipulador para o botão "Limpar"
            $("#limpar-form").click(function() {
                // Limpe os resultados na página
                $('#resultados li').remove();
                // Limpe os dados do armazenamento local
                localStorage.removeItem('formData');
                // Recarregue a página
                location.reload();
            });

            // Manipulador para o evento de alteração do campo "Número de Linhas Extras"
            $("#num-rows").change(function() {
                var numRows = parseInt($("#num-rows").val()) || 0;
                $('#formset-table tbody').empty();
                for (var i = 0; i < numRows; i++) {
                    addRow();
                }
            });

            // Manipulador para o envio do formulário
            $('form').submit(function() {
                // Salve os dados no armazenamento local antes de enviar o formulário
                saveFormData();
            });

            // Manipulador para o botão "Salvar no Banco de Dados"
            $("#salvar-form").click(function () {
                salvarNoBancoDeDados();
            });

            // Manipulador para o botão "Ver Resultado"
            $("#ver-resultado").click(function () {
                processarPrevisao();
            });

            // Função para enviar os dados do formulário para o servidor e salvar no banco de dados
            function salvarNoBancoDeDados() {
                var formData = {
                    num_rows: $('#num-rows').val(),
                    dados: []
                };
                $('#formset-table tbody tr').each(function () {
                    var row = {};
                    $(this).find('input[type="number"]').each(function () {
                        row[$(this).attr('name')] = $(this).val();
                    });
                    formData.dados.push(row);
                });

                $.ajax({
                    type: 'POST',
                    url: '/salvar_dados/',  // Substitua pelo URL correto do seu servidor Django
                    data: JSON.stringify(formData),
                    contentType: 'application/json',
                    dataType: 'json',
                    success: function (response) {
                        // Handle success, se necessário
                        console.log('Dados salvos com sucesso.');
                    },
                    error: function (error) {
                        // Handle error, se necessário
                        console.error('Erro ao salvar os dados.');
                    }
                });
            }

            // Função para processar a previsão e exibir os resultados
            function processarPrevisao() {
                var formData = {
                    num_rows: $('#num-rows').val(),
                    dados: []
                };
                $('#formset-table tbody tr').each(function () {
                    var row = {};
                    $(this).find('input[type="number"]').each(function () {
                        row[$(this).attr('name')] = $(this).val();
                    });
                    formData.dados.push(row);
                });

                $.ajax({
                    type: 'POST',
                    url: '/processar_previsao/',
                    data: JSON.stringify(formData),
                    contentType: 'application/json',
                    dataType: 'json',
                    success: function (response) {
                        $('#resultados-list').empty();
                        for (var i = 0; i < response.resultados.length; i++) {
                            adicionarResultado(response.previsao_id, response.resultados[i]);
                        }
                    },
                    error: function (error) {
                        // Mostra o erro se for necessario
                        console.error('Erro ao processar a previsão.');
                    }
                });
            }
        });
    </script>
</body>
</html>
